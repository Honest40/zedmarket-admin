<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket Admin ğŸ‡¿ğŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
header{background:#0f2a44;color:#fff;padding:15px;text-align:center;font-size:22px}
section{padding:15px}
.card{background:#fff;padding:12px;margin:10px 0;border-radius:6px}
button{padding:7px 12px;border:none;border-radius:5px;cursor:pointer;margin:3px}
.approve{background:#198754;color:#fff}
.reject{background:#dc3545;color:#fff}
.feature{background:#ffc107}
.verify{background:#0d6efd;color:#fff}
img{width:100%;max-height:200px;object-fit:cover;border-radius:5px}
input{width:100%;padding:8px;margin:6px 0}
.chatBox{height:200px;overflow:auto;background:#fafafa;padding:8px;margin-bottom:5px}
</style>
</head>

<body>

<header>ZedMarket Admin Panel ğŸ‡¿ğŸ‡²</header>

<section id="loginBox">
<h3>Admin Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
</section>

<section id="adminBox" style="display:none">

<h3>ğŸ•’ Pending Listings</h3>
<div id="pendingListings"></div>

<h3>ğŸ‘¥ Users</h3>
<div id="users"></div>

<h3>ğŸ’¬ Support Chats</h3>
<div id="chats"></div>

<button onclick="logout()">Logout</button>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain: "pa-mwera.firebaseapp.com",
  projectId: "pa-mwera",
  storageBucket: "pa-mwera.firebasestorage.app",
  messagingSenderId: "959795010421",
  appId: "1:959795010421:web:84e1cc1517a5d98598113c"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const loginBox = document.getElementById("loginBox");
const adminBox = document.getElementById("adminBox");
const pendingDiv = document.getElementById("pendingListings");
const usersDiv = document.getElementById("users");
const chatsDiv = document.getElementById("chats");

/* LOGIN */
document.getElementById("loginBtn").onclick = () => {
  auth.signInWithEmailAndPassword(
    email.value,
    password.value
  ).catch(e=>alert(e.message));
};

/* AUTH CHECK */
auth.onAuthStateChanged(async user=>{
  if(!user) return;

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role!=="admin"){
    alert("Not an admin");
    auth.signOut();
    return;
  }

  loginBox.style.display="none";
  adminBox.style.display="block";
  loadPending();
  loadUsers();
  loadChats();
});

function logout(){
  auth.signOut();
  location.reload();
}

/* LISTINGS */
function loadPending(){
  db.collection("listings")
    .where("status","in",["pending","pending_payment"])
    .onSnapshot(snap=>{
      pendingDiv.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        pendingDiv.innerHTML+=`
        <div class="card">
          <img src="${d.image || 'https://via.placeholder.com/300'}">
          <h4>${d.title}</h4>
          <p>${d.price} â€¢ ${d.type}</p>
          <button class="approve" onclick="approve('${doc.id}')">Approve</button>
          <button class="feature" onclick="feature('${doc.id}')">Feature</button>
          <button class="reject" onclick="reject('${doc.id}')">Reject</button>
        </div>`;
      });
    });
}

function approve(id){
  db.collection("listings").doc(id).update({status:"approved"});
}

function feature(id){
  db.collection("listings").doc(id).update({
    featured:true,
    status:"approved"
  });
}

function reject(id){
  if(confirm("Delete listing?")){
    db.collection("listings").doc(id).delete();
  }
}

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    usersDiv.innerHTML="";
    snap.forEach(doc=>{
      const u=doc.data();
      usersDiv.innerHTML+=`
      <div class="card">
        <b>${u.name||"No name"}</b><br>
        ${u.phone||""}<br>
        Role: ${u.role||"seller"}<br>
        Verified: ${u.verified?"âœ…":"âŒ"}<br>
        <button class="verify" onclick="verify('${doc.id}')">Verify</button>
      </div>`;
    });
  });
}

function verify(uid){
  db.collection("users").doc(uid).update({verified:true});
}

/* SUPPORT CHAT */
function loadChats(){
  db.collection("messages").onSnapshot(snap=>{
    chatsDiv.innerHTML="";
    snap.forEach(chat=>{
      chatsDiv.innerHTML+=`
      <div class="card">
        <b>${chat.id}</b>
        <div class="chatBox" id="box_${chat.id}"></div>
        <input placeholder="Reply..." 
          onkeydown="if(event.key==='Enter')sendReply('${chat.id}',this)">
      </div>`;
      loadChatMessages(chat.id);
    });
  });
}

function loadChatMessages(chatId){
  db.collection("messages")
    .doc(chatId)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      const box=document.getElementById("box_"+chatId);
      if(!box) return;
      box.innerHTML="";
      snap.forEach(m=>{
        const d=m.data();
        box.innerHTML+=`
          <div><b>${d.from==="admin"?"Admin":"User"}:</b> ${d.text}</div>`;
      });
      box.scrollTop=box.scrollHeight;
    });
}

function sendReply(chatId,input){
  if(!input.value) return;
  db.collection("messages")
    .doc(chatId)
    .collection("messages")
    .add({
      from:"admin",
      text:input.value,
      time:Date.now()
    });
  input.value="";
}
</script>

</body>
</html>
