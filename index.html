<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket Admin Panel üáøüá≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --green:#198754;
  --orange:#ff8c00;
  --dark:#0f2a44;
  --red:#dc3545;
  --gray:#6c757d;
}
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
header{background:var(--dark);color:#fff;padding:15px;text-align:center;font-size:22px}
section{display:none;padding:15px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button{background:var(--green);color:#fff;font-weight:bold;cursor:pointer}
button.red{background:var(--red)}
button.gray{background:var(--gray)}
.card{background:#fff;border-radius:10px;padding:10px;margin:10px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.badge{display:inline-block;background:var(--orange);color:#000;padding:3px 6px;border-radius:4px;font-size:12px;margin-left:4px}
.badge.verified{background:var(--green);color:#fff}
.badge.pending{background:var(--gray);color:#fff}
.badge.approved{background:var(--green);color:#fff}
.badge.featured{background:#ffc107;color:#000}
img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:8px;background:#eee}
h3{margin-top:0}
.searchBox{padding:6px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px}
.sortBox{padding:6px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px}
.navbar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.navbar button{flex:1;border:none;padding:10px;color:#fff;border-radius:6px;font-size:15px;cursor:pointer;margin:2px}
.navbar button.active{background:var(--green)}
</style>
</head>
<body>

<header>ZedMarket Admin Panel üáøüá≤</header>

<!-- Login Section -->
<section id="adminAuth" style="display:block;">
  <h3>Admin Login</h3>
  <input id="adminEmail" placeholder="Email">
  <input id="adminPassword" type="password" placeholder="Password">
  <button id="adminLoginBtn">Login</button>
</section>

<!-- Admin Dashboard -->
<section id="adminDashboard">
  <div class="navbar">
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="listingsTab">Listings</button>
    <button data-tab="usersTab">Users</button>
    <button data-tab="profileTab">Profile</button>
    <button id="adminLogout">Logout</button>
  </div>

  <!-- Dashboard / Notifications -->
  <div id="dashboard">
    <h3>New Listing Notifications</h3>
    <div id="notifications"></div>
  </div>

  <!-- Listings Management -->
  <div id="listingsTab">
    <h3>All Listings</h3>
    <input class="searchBox" id="listingSearch" placeholder="Search by title or seller...">
    <select class="sortBox" id="listingSort">
      <option value="newest">Newest First</option>
      <option value="priceLow">Price Low ‚Üí High</option>
      <option value="priceHigh">Price High ‚Üí Low</option>
    </select>
    <div id="allListings"></div>
  </div>

  <!-- Users Management -->
  <div id="usersTab">
    <h3>All Users</h3>
    <input class="searchBox" id="userSearch" placeholder="Search by name or email...">
    <div id="allUsers"></div>
  </div>

  <!-- Admin Profile -->
  <div id="profileTab">
    <h3>Profile</h3>
    <input id="adminName" placeholder="Name">
    <input id="adminNewPass" type="password" placeholder="New Password">
    <button onclick="saveAdminProfile()">Save Profile</button>
  </div>
</section>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain:"pa-mwera.firebaseapp.com",
  projectId:"pa-mwera"
});

const auth=firebase.auth();
const db=firebase.firestore();

const adminAuth=document.getElementById("adminAuth");
const adminDashboard=document.getElementById("adminDashboard");
const sectionsTabs=adminDashboard.querySelectorAll("#dashboard, #listingsTab, #usersTab, #profileTab");

// Show tab
function showTab(id){
  sectionsTabs.forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".navbar button[data-tab]").forEach(b=>b.classList.remove("active"));
  const btn=document.querySelector(`.navbar button[data-tab="${id}"]`);
  if(btn)btn.classList.add("active");
}

// --- ADMIN LOGIN ---
document.getElementById("adminLoginBtn").onclick=async()=>{
  const email=adminEmail.value.trim();
  const pass=adminPassword.value.trim();
  if(!email || !pass){ alert("Enter email & password"); return; }
  try{
    const res = await auth.signInWithEmailAndPassword(email, pass);

    // --- TEMPORARY FOR TESTING: Skip Firestore admin check ---
    // You can enable this later by uncommenting below:
    // const adminDoc = await db.collection("admins").doc(res.user.uid).get();
    // if(!adminDoc.exists){ alert("Not an admin"); auth.signOut(); return; }

    adminAuth.style.display="none";
    adminDashboard.style.display="block";
    loadAdminProfile();
    listenListings();
    listenUsers();
    showTab('dashboard');
  }catch(e){alert(e.message);}
};

// Admin Logout
document.getElementById("adminLogout").onclick=()=>{auth.signOut(); adminDashboard.style.display="none"; adminAuth.style.display="block";};

// Navbar tab buttons
document.querySelectorAll(".navbar button[data-tab]").forEach(b=>{b.onclick=()=>showTab(b.dataset.tab);});

// Load Admin Profile
async function loadAdminProfile(){
  const u = auth.currentUser;
  if(!u) return;
  // For demo, just set the email as name placeholder
  adminName.value = u.email || "";
}
async function saveAdminProfile(){
  const u = auth.currentUser;
  if(!u) return;
  const nameVal = adminName.value.trim();
  const newPass = adminNewPass.value.trim();
  if(nameVal) alert("Name saved (demo)");
  if(newPass) await u.updatePassword(newPass);
  alert("Profile updated!");
  adminNewPass.value="";
}

// --- LISTINGS ---
function listenListings(){
  db.collection("listings").orderBy("createdAt","desc").onSnapshot(async snap=>{
    const arr = [];
    for(const doc of snap.docs){
      arr.push({id:doc.id,...doc.data()});
    }
    displayListings(arr);
    displayNotifications(arr.filter(d=>d.status==="pending"));
  });
}

async function displayListings(listingsArr){
  const container = document.getElementById("allListings");
  const searchTerm = document.getElementById("listingSearch").value.toLowerCase();
  const sortValue = document.getElementById("listingSort").value;

  let filtered = listingsArr.filter(d=>{
    return !searchTerm || (d.title.toLowerCase().includes(searchTerm) || (d.sellerName && d.sellerName.toLowerCase().includes(searchTerm)));
  });

  filtered.sort((a,b)=>{
    if(sortValue==="newest") return b.createdAt - a.createdAt;
    if(sortValue==="priceLow") return parseFloat(a.price)-parseFloat(b.price);
    if(sortValue==="priceHigh") return parseFloat(b.price)-parseFloat(a.price);
  });

  container.innerHTML="";
  for(const d of filtered){
    let sellerName="Unknown";
    let sellerVerified=false;
    if(d.sellerId){
      const doc = await db.collection("users").doc(d.sellerId).get();
      if(doc.exists){ sellerName = doc.data().name || sellerName; sellerVerified = doc.data().verified || false; }
    }
    const imgUrl = d.image && d.image.trim()!=="" ? d.image : 'https://via.placeholder.com/300';
    container.innerHTML+=`
    <div class="card">
      <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/300'">
      <h4>${d.title} ${d.featured?'<span class="badge featured">SPONSORED</span>':''}</h4>
      <div class="${d.status==='pending'?'badge pending':'badge approved'}">${d.status.toUpperCase()}</div>
      <div>${sellerVerified?'<span class="badge verified">VERIFIED SELLER</span>':''} Seller: ${sellerName}</div>
      <div class="price">${d.price}</div>
      <button onclick="approveListing('${d.id}')">‚úÖ Approve</button>
      <button class="red" onclick="rejectListing('${d.id}')">‚ùå Reject</button>
      <button onclick="featureListing('${d.id}', ${d.featured})">${d.featured?'Unfeature':'Feature'}</button>
      <button onclick="deleteListingAdmin('${d.id}')">Delete</button>
    </div>`;
  }
}

// Notifications
function displayNotifications(pendingArr){
  const container = document.getElementById("notifications");
  container.innerHTML="";
  pendingArr.forEach(d=>{
    container.innerHTML+=`<div class="card"><strong>${d.title}</strong> submitted by ${d.sellerId} at ${new Date(d.createdAt).toLocaleString()}</div>`;
  });
}

// Listing Actions
async function approveListing(id){ await db.collection("listings").doc(id).update({status:"approved"}); }
async function rejectListing(id){ await db.collection("listings").doc(id).update({status:"rejected"}); }
async function featureListing(id, current){ await db.collection("listings").doc(id).update({featured:!current}); }
async function deleteListingAdmin(id){ if(confirm("Delete listing?")){await db.collection("listings").doc(id).delete(); }}

// --- USERS ---
function listenUsers(){
  db.collection("users").onSnapshot(snap=>{
    const arr = [];
    snap.forEach(doc=>{
      arr.push({id:doc.id,...doc.data()});
    });
    displayUsers(arr);
  });
}

function displayUsers(usersArr){
  const container = document.getElementById("allUsers");
  const searchTerm = document.getElementById("userSearch").value.toLowerCase();
  container.innerHTML="";
  usersArr.forEach(u=>{
    if(searchTerm && !u.name.toLowerCase().includes(searchTerm) && !u.email.toLowerCase().includes(searchTerm)) return;
    container.innerHTML+=`
    <div class="card">
      <div><strong>${u.name}</strong> (${u.email})</div>
      <div>Verified: ${u.verified?'‚úîÔ∏è':'‚ùå'}</div>
      <div>Registered: ${new Date(u.createdAt).toLocaleString()}</div>
      <button onclick="toggleVerify('${u.id}',${u.verified})">${u.verified?'Unverify':'Verify'}</button>
      <button class="red" onclick="blockUser('${u.id}')">Block</button>
    </div>`;
  });
}

// User Actions
async function toggleVerify(uid, current){ await db.collection("users").doc(uid).update({verified:!current}); }
async function blockUser(uid){ if(confirm("Block this user?")){ await db.collection("users").doc(uid).update({blocked:true}); }}

// Search Events
document.getElementById("listingSearch").addEventListener("input", ()=>listenListings());
document.getElementById("listingSort").addEventListener("change", ()=>listenListings());
document.getElementById("userSearch").addEventListener("input", ()=>listenUsers());
</script>
</body>
</html>
