<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZedMarket Admin Pro ðŸ‡¿ðŸ‡²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f5f5f5}
header{background:#0f2a44;color:#fff;padding:15px;text-align:center;font-size:22px;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
section{padding:15px}
.card{background:#fff;padding:12px;margin:10px 0;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
button{padding:7px 12px;border:none;border-radius:5px;cursor:pointer;margin:3px}
.approve{background:#198754;color:#fff}
.reject{background:#dc3545;color:#fff}
.feature{background:#ffc107;color:#000}
.verify{background:#0d6efd;color:#fff}
.block{background:#6c757d;color:#fff}
.delete{background:#dc3545;color:#fff}
.promote{background:#6610f2;color:#fff}
img{width:100%;max-height:200px;object-fit:cover;border-radius:5px}
input,select{width:100%;padding:8px;margin:6px 0;border-radius:5px;border:1px solid #ccc;}
.chatBox{height:200px;overflow:auto;background:#fafafa;padding:8px;margin-bottom:5px;border-radius:5px;border:1px solid #ccc;}
.stats{display:flex;justify-content:space-around;margin-bottom:15px;flex-wrap:wrap;}
.stats div{background:#fff;padding:10px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);text-align:center;flex:1;margin:5px;}
.badge{display:inline-block;padding:3px 6px;background:#ffc107;border-radius:3px;font-size:12px;margin-left:5px;color:#000;}
canvas{background:#fff;border-radius:6px;margin:10px 0;padding:10px;}
</style>
</head>
<body>

<header>ZedMarket Admin Pro ðŸ‡¿ðŸ‡²</header>

<section id="loginBox">
<h3>Admin Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
</section>

<section id="adminBox" style="display:none">

<div class="stats">
  <div>Total Listings: <span id="totalListings">0</span></div>
  <div>Pending: <span id="pendingCount">0</span></div>
  <div>Featured: <span id="featuredCount">0</span></div>
  <div>Total Users: <span id="totalUsers">0</span></div>
  <div>Verified Users: <span id="verifiedUsers">0</span></div>
</div>

<h3>ðŸ“Š Listings Analytics</h3>
<canvas id="listingChart" width="400" height="150"></canvas>

<h3>ðŸ•’ Pending Listings</h3>
<div id="pendingListings"></div>

<h3>âœ… Approved Listings</h3>
<div id="approvedListings"></div>

<h3>ðŸ‘¥ Users</h3>
<input id="userSearch" placeholder="Search users...">
<div id="users"></div>

<h3>ðŸ’¬ Support Chats</h3>
<div id="chats"></div>

<h3>Profile</h3>
<input id="adminName" placeholder="Admin Name">
<input id="adminPhone" placeholder="Phone">
<button id="saveAdminProfile">Save Profile</button>

<button onclick="logout()">Logout</button>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDhRFgn7nXoZlRf-GX7XakwUYrEMFZDgrI",
  authDomain: "pa-mwera.firebaseapp.com",
  projectId: "pa-mwera",
  storageBucket: "pa-mwera.firebasestorage.app",
  messagingSenderId: "959795010421",
  appId: "1:959795010421:web:84e1cc1517a5d98598113c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBox = document.getElementById("loginBox");
const adminBox = document.getElementById("adminBox");
const pendingDiv = document.getElementById("pendingListings");
const approvedDiv = document.getElementById("approvedListings");
const usersDiv = document.getElementById("users");
const chatsDiv = document.getElementById("chats");
const totalListingsSpan = document.getElementById("totalListings");
const pendingCountSpan = document.getElementById("pendingCount");
const featuredCountSpan = document.getElementById("featuredCount");
const totalUsersSpan = document.getElementById("totalUsers");
const verifiedUsersSpan = document.getElementById("verifiedUsers");
const userSearch = document.getElementById("userSearch");
const adminName = document.getElementById("adminName");
const adminPhone = document.getElementById("adminPhone");
const saveAdminProfile = document.getElementById("saveAdminProfile");

let listingChart;

// Default admin
const ADMIN_EMAIL = "hbforlife40@gmail.com";
const ADMIN_PASSWORD = "mother";

// Ensure admin exists
async function ensureAdmin(){
  try{
    let cred = await auth.signInWithEmailAndPassword(ADMIN_EMAIL,ADMIN_PASSWORD);
    let adminUser = cred.user;
    let doc = await db.collection("users").doc(adminUser.uid).get();
    if(!doc.exists){
      await db.collection("users").doc(adminUser.uid).set({
        role:"admin",
        name:"ZedMarket Admin",
        phone:"0978652424",
        verified:true,
        createdAt:Date.now()
      });
    }else{
      await db.collection("users").doc(adminUser.uid).update({role:"admin"});
    }
    return adminUser;
  }catch(e){
    if(e.code==="auth/user-not-found"){
      const cred = await auth.createUserWithEmailAndPassword(ADMIN_EMAIL,ADMIN_PASSWORD);
      await db.collection("users").doc(cred.user.uid).set({
        role:"admin",
        name:"ZedMarket Admin",
        phone:"0978652424",
        verified:true,
        createdAt:Date.now()
      });
      return cred.user;
    }
    alert(e.message);
  }
}

document.getElementById("loginBtn").onclick = async ()=>{
  const user = await ensureAdmin();
  if(user){
    loginBox.style.display="none";
    adminBox.style.display="block";
    loadListings();
    loadUsers();
    loadChats();
    loadAdminProfile();
  }
};

function logout(){ auth.signOut(); location.reload(); }

// Load Listings
function loadListings(){
  db.collection("listings").onSnapshot(snap=>{
    pendingDiv.innerHTML="";
    approvedDiv.innerHTML="";
    let total=0, pending=0, featured=0;
    let approvedCount=0, rejectedCount=0;
    snap.forEach(doc=>{
      const d = doc.data();
      total++;
      if(d.status==="pending") pending++;
      if(d.featured) featured++;
      if(d.status==="approved") approvedCount++;
      if(d.status==="rejected") rejectedCount++;
      const card = `<div class="card">
        <img src="${d.image||'https://via.placeholder.com/300'}">
        <h4>${d.title}</h4>
        <p>${d.price} â€¢ ${d.type} â€¢ Status: ${d.status}</p>
        <p>Seller: ${d.sellerName||"Unknown"} ${d.sellerVerified?'<span class="badge">VERIFIED</span>':''}</p>
        ${d.status==="pending"?`
        <button class="approve" onclick="approve('${doc.id}')">Approve</button>
        <button class="feature" onclick="feature('${doc.id}')">Feature</button>
        <button class="reject" onclick="reject('${doc.id}')">Reject</button>
        <button class="delete" onclick="deleteListing('${doc.id}')">Delete</button>`:''}
      </div>`;
      if(d.status==="pending") pendingDiv.innerHTML+=card;
      else approvedDiv.innerHTML+=card;
    });
    totalListingsSpan.textContent=total;
    pendingCountSpan.textContent=pending;
    featuredCountSpan.textContent=featured;

    // Update chart
    const ctx = document.getElementById('listingChart').getContext('2d');
    if(listingChart) listingChart.destroy();
    listingChart = new Chart(ctx,{
      type:'bar',
      data:{
        labels:['Pending','Approved','Rejected','Featured'],
        datasets:[{
          label:'Listings',
          data:[pending,approvedCount,rejectedCount,featured],
          backgroundColor:['#dc3545','#198754','#6c757d','#ffc107']
        }]
      },
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  });
}

function approve(id){ db.collection("listings").doc(id).update({status:"approved"}); }
function feature(id){ db.collection("listings").doc(id).update({featured:true,status:"approved"}); }
function reject(id){ if(confirm("Reject listing?")) db.collection("listings").doc(id).update({status:"rejected"}); }
function deleteListing(id){ if(confirm("Delete listing permanently?")) db.collection("listings").doc(id).delete(); }

// Load Users
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    usersDiv.innerHTML="";
    let total=0, verified=0;
    snap.forEach(doc=>{
      const u = doc.data();
      if(u.name.toLowerCase().includes(userSearch.value.toLowerCase())){
        total++;
        if(u.verified) verified++;
        usersDiv.innerHTML+=`
        <div class="card">
          <b>${u.name||"No name"}</b> ${u.verified?'<span class="badge">VERIFIED</span>':''}<br>
          ${u.phone||""}<br>
          Role: ${u.role||"seller"}<br>
          <button class="verify" onclick="verify('${doc.id}')">Verify</button>
          <button class="block" onclick="block('${doc.id}')">${u.blocked?"Unblock":"Block"}</button>
          <button class="promote" onclick="promote('${doc.id}')">Promote</button>
          <button class="delete" onclick="deleteUser('${doc.id}')">Delete</button>
        </div>`;
      }
    });
    totalUsersSpan.textContent=total;
    verifiedUsersSpan.textContent=verified;
  });
}
userSearch.addEventListener("input", loadUsers);

function verify(uid){ db.collection("users").doc(uid).update({verified:true}); }
function block(uid){ db.collection("users").doc(uid).update({blocked:true}); }
function promote(uid){ db.collection("users").doc(uid).update({role:"admin"}); }
function deleteUser(uid){ if(confirm("Delete user permanently?")) db.collection("users").doc(uid).delete(); }

// Load Support Chats
function loadChats(){
  db.collection("messages").onSnapshot(snap=>{
    chatsDiv.innerHTML="";
    snap.forEach(chat=>{
      chatsDiv.innerHTML+=`
      <div class="card">
        <b>${chat.id}</b>
        <div class="chatBox" id="box_${chat.id}"></div>
        <input placeholder="Reply..." onkeydown="if(event.key==='Enter')sendReply('${chat.id}',this)">
      </div>`;
      loadChatMessages(chat.id);
    });
  });
}

function loadChatMessages(chatId){
  db.collection("messages").doc(chatId).collection("messages").orderBy("time")
    .onSnapshot(snap=>{
      const box=document.getElementById("box_"+chatId);
      if(!box) return;
      box.innerHTML="";
      snap.forEach(m=>{
        const d=m.data();
        box.innerHTML+=`<div><b>${d.from==="admin"?"Admin":"User"}:</b> ${d.text}</div>`;
      });
      box.scrollTop = box.scrollHeight;
    });
}

function sendReply(chatId,input){
  if(!input.value) return;
  db.collection("messages").doc(chatId).collection("messages").add({
    from:"admin",
    text:input.value,
    time:Date.now()
  });
  input.value="";
}

// Admin Profile
async function loadAdminProfile(){
  const user = auth.currentUser;
  if(!user) return;
  const doc = await db.collection("users").doc(user.uid).get();
  if(doc.exists){
    const d = doc.data();
    adminName.value=d.name||"";
    adminPhone.value=d.phone||"";
  }
}

saveAdminProfile.onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  await db.collection("users").doc(user.uid).update({
    name: adminName.value,
    phone: adminPhone.value
  });
  alert("Profile updated!");
}
</script>
</body>
</html>
